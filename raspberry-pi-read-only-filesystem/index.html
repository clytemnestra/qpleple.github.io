<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Raspberry Pi Read Only Filesystem</title>
    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/style.css">

    
        
    

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18013119-1']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>
<body>
 
<div class="container">
  <div id="page" style="position: relative">
    
    
    <h1>Raspberry Pi Read Only Filesystem</h1>
    
    <div id="post-content">
        <p><a href="http://www.raspberrypi.org/phpBB3/viewtopic.php?f=29&amp;t=22596">Raspberry Pi read only</a>
<a href="https://wiki.debian.org/ReadonlyRoot">Mounting filesystem root readonly on Debian</a></p>

<p><a href="http://ruiabreu.org/2013-06-02-booting-raspberry-pi-in-readonly.html">Booting Raspberry Pi Root in read-only</a>
Only Arch</p>

<p><a href="http://riscpi.co.uk/nutcom-services-ltd/">Industrial Perennial Environment distribution for R-Pi</a>
&quot;IPE is a special blackout-proof flavour of Raspbian. Its aim is to provide a solid OS for using in environments where blackouts are common. IPE achieves its goal by using a full read-only file system with slightly modified tools.&quot;</p>

<p>Series:
1. <a href="http://www.a-netz.de/2013/02/ramdisks-for-the-raspberry/">Ramdisks for the Raspberry</a>
2. <a href="http://www.a-netz.de/2013/02/persistent-storage-with-ramdisks/">Persistent storage with ramdisks</a>
3. <a href="http://www.a-netz.de/2013/02/read-only-root-filesystem/">Read-only root filesystem</a></p>

<h2>Experiments</h2>

<p>Initial /etc/fstab:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">proc            /proc           proc    defaults           0   0
/dev/mmcblk0p1  /boot           vfat    defaults           0   0
/dev/mmcblk0p2  /               ext4    defaults,noatime   0   0
</code></pre></div>
<p>Changed to:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">proc            /proc           proc    defaults           0   0
/dev/mmcblk0p1  /boot           vfat    ro,noatime         0   0
/dev/mmcblk0p2  /               ext4    ro,noatime         0   0
tmpfs           /tmp            tmpfs   defaults,noatime   0   0
tmpfs           /var/log        tmpfs   defaults,noatime   0   0
tmpfs           /var/lock       tmpfs   defaults,noatime   0   0
</code></pre></div>
<p>Explanation:
- keep the <code>noatime</code> option even with <code>ro</code> for when the disk is RW when working on it, see <a href="http://www.howtoforge.com/reducing-disk-io-by-mounting-partitions-with-noatime">Reducing Disk IO By Mounting Partitions With noatime</a>
- move /tmp, /var/log and /var/lock to RAM</p>

<p>Switch / to RW:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">mount / -o remount,rw
</code></pre></div>
<p>Switch back / to RO:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">mount / -o remount,ro
</code></pre></div>
<p>How I use it:
- when I&#39;m working on it through SSH, I start my session by making / RW and end it by setting it back to RO.
- when the device is used headless, it boots with / RO and doesn&#39;t have to write on the FS</p>

<h2>Errors to fix</h2>

<p>Three startegies:
- disable the service
- make it write in a temporary location
- ignore error message</p>

<h2>sudo -&gt; ignore</h2>

<p>/var/lib/sudo
error displayed but still work ok</p>

<h2>dhcp</h2>

<ol>
<li>samba dhcp</li>
<li>dhcp-client</li>
</ol>

<h2>dns</h2>

<p>/etc/resolv.conf for dns resolution
http://raspberrypi.stackexchange.com/questions/5112/running-on-read-only-sd-card</p>

<h2>fake clock -&gt; disable</h2>

<p>/etc/fake-hwclock.data for last time/date known
http://www.a-netz.de/2013/02/read-only-root-filesystem/
disable the service: consequence = when not connected to the network (no ntp servers), date will be 1970</p>

<h2>logrotate? -&gt; write to a temp location</h2>

<p>/var/lib/logrotate for internal state
http://www.a-netz.de/2013/02/read-only-root-filesystem/
add logrotate option &quot;–state /var/log/logrotate.state&quot; in the cron /etc/cron.daily/logrotate</p>

<h2>apt-get</h2>

<p>needs to write to fs
option 1: make the / RW, use apt-get, then put it back to RO
option 2: automatize this https://wiki.debian.org/ReadonlyRoot#Make<em>apt-get</em>remount<em>.2F</em>if_needed</p>

<h2>swap</h2>

<p>swapon: /var/swap: swapon failed: Read-only file system</p>

<h2>Debugging: Find processes blocking the remount readonly</h2>

<p>https://wiki.debian.org/ReadonlyRoot#Find<em>processes</em>blocking<em>the</em>remount_readonly</p>

    </div>

    <div id="card-post">
        <img class="img-circle pull-left" style="height: 50px" src="/img/picture.jpg">
        <a href="/">Quentin Pleplé</a> <br>
        <span class="muted">
            January 2014
        </span>
    </div>

</div>

<div id="disqus_thread" style="padding: 60px 40px 20px 40px"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'qpleple'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</body>
</html>
